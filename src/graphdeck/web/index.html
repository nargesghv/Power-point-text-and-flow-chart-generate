<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>GraphDeck ‚ú®</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{
      --bg:#070915; --card:rgba(255,255,255,.06); --line:rgba(255,255,255,.10);
      --text:#e8ecff; --muted:#a7b3e6; --accent1:#6366f1; --accent2:#ec4899;
      --ok:#bbf7d0; --err:#fecaca; --link:#93c5fd;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,Segoe UI,Inter,Roboto,Arial}
    a{color:var(--link)}
    .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
    .row{display:grid;gap:16px}
    @media(min-width:1100px){.row{grid-template-columns:2fr 1fr}}
    .btn{padding:10px 14px;border-radius:12px;font-weight:700;border:1px solid var(--line);
      background:linear-gradient(135deg,rgba(99,102,241,.25),rgba(236,72,153,.25));color:var(--text);cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .badge{display:inline-flex;gap:8px;padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.10);
      border:1px solid var(--line);font-size:12px}
    .input{width:100%;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);
      border:1px solid var(--line);color:var(--text)}
    .stack{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
    .links a{text-decoration:underline}
    pre{white-space:pre-wrap;margin:0}
    details{border:1px dashed var(--line);border-radius:12px;padding:8px}
    summary{cursor:pointer;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;margin:2px 8px 8px 0;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line)}
    .pill a{color:var(--text);text-decoration:none}
    .pill small{opacity:.7}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="stack" style="justify-content:space-between;margin-bottom:14px">
      <h1 style="font-weight:900;font-size:32px;letter-spacing:-.02em;margin:0">GraphDeck ‚ú®</h1>
      <div class="stack">
        <button id="runAll" class="btn">‚ú® Run All</button>
        <button id="runManual" class="btn">ü™Ñ Step by Step</button>
        <label class="badge"><input id="fast" type="checkbox" checked/> ‚ö° Fast</label>
        <span id="busy" class="badge" style="display:none">Working‚Ä¶</span>
      </div>
    </header>

    <!-- Topic + Backend configuration -->
    <div class="panel" style="margin-bottom:16px">
      <div class="row" style="grid-template-columns:2fr 1fr">
        <div>
          <label style="font-size:12px;opacity:.7">Topic</label>
          <input id="topic" class="input" value="AI in marketing" placeholder="e.g., Milan fashion sustainability"/>
        </div>
        <div>
          <div class="kv">
            <label style="font-size:12px;opacity:.7;padding-top:6px">Backend URL</label>
            <input id="backendUrl" class="input" value="http://localhost:8003" placeholder="https://your-backend.example.com"/>
          </div>
          <div class="stack" style="margin-top:8px">
            <label class="badge"><input id="useProxy" type="checkbox"/> Use Netlify proxy (/v1 ‚Üí backend)</label>
            <button id="saveCfg" class="btn" style="padding:6px 10px">Save</button>
          </div>
          <small style="opacity:.65">For Netlify production, enable ‚ÄúUse Netlify proxy‚Äù and configure redirects in <code>netlify.toml</code>. Local dev can call <code>http://localhost:8003</code> directly.</small>
        </div>
      </div>
    </div>

    <!-- Output panels -->
    <div class="row">
      <div class="panel">
        <div class="stack" style="margin-bottom:6px">
          <span class="badge">Slides (text)</span>
          <span id="artStatus" class="badge" style="display:none"></span>
        </div>
        <div id="slides" style="min-height:320px;opacity:.95">No content yet. Run the pipeline.</div>
      </div>

      <div class="panel">
        <div class="stack" style="margin-bottom:6px">
          <span class="badge">Slide 3 Flowchart</span>
        </div>
        <div id="flowWrap" style="min-height:220px;opacity:.95">No diagram yet.</div>
        <div id="links" class="links" style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap"></div>
      </div>
    </div>

    <!-- Research / Summary / Blog quick peek -->
    <div class="row" style="margin-top:16px">
      <div class="panel">
        <h3 style="margin:0 0 8px 0">Artifacts</h3>
        <div id="artifactPills" class="stack"></div>
      </div>
      <div class="panel">
        <h3 style="margin:0 0 6px 0">Backend</h3>
        <div id="health" class="mono" style="font-size:12px;opacity:.85">Checking‚Ä¶</div>
      </div>
    </div>

    <!-- Activity log -->
    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 6px 0">Activity</h3>
      <div id="log" class="mono" style="font-size:12px;max-height:260px;overflow:auto"></div>
    </div>

    <!-- PREVIEWS -->
    <div class="row" style="margin-top:16px">
      <div class="panel">
        <h3 style="margin:0 0 6px 0">Summary (preview)</h3>
        <div id="summary" style="min-height:120px;opacity:.95">‚Äî</div>
      </div>
      <div class="panel">
        <h3 style="margin:0 0 6px 0">Blog (preview)</h3>
        <div id="blog" style="min-height:120px;opacity:.95">‚Äî</div>
      </div>
    </div>
  </div>

  <script>
    // ------- Config / helpers -------
    const qs = s => document.querySelector(s);
    const logEl = qs("#log"), slidesEl = qs("#slides"), flowEl = qs("#flowWrap"),
          linksEl = qs("#links"), busyEl = qs("#busy"), artStatus = qs("#artStatus"),
          pillsEl = qs("#artifactPills"), summaryEl = qs("#summary"), blogEl = qs("#blog");
    const topicEl = qs("#topic"), fastEl = qs("#fast");
    const backendEl = qs("#backendUrl"), proxyEl = qs("#useProxy");

    function loadCfg(){
      const saved = JSON.parse(localStorage.getItem("graphdeck_cfg") || "{}");
      if (saved.backend) backendEl.value = saved.backend;
      if (typeof saved.proxy === "boolean") proxyEl.checked = saved.proxy;
    }
    function saveCfg(){
      localStorage.setItem("graphdeck_cfg", JSON.stringify({
        backend: backendEl.value.trim(),
        proxy: proxyEl.checked
      }));
      alert("Saved.");
    }
    qs("#saveCfg").onclick = saveCfg;
    loadCfg();

    function backendBase(){
      // If proxy mode, keep empty so we call /v1 on the same origin and let Netlify redirect.
      const backend = backendEl.value.trim();
      if (proxyEl.checked) return "";
      return backend || "";
    }
    function api(path){
      const base = backendBase();
      if (!base) return path; // proxy mode or same-origin dev
      return base.replace(/\/+$/,"") + path;
    }
    function setBusy(on){ busyEl.style.display = on ? "inline-flex" : "none"; }
    function log(m, ok=true){
      const d=document.createElement("div");
      d.textContent=(ok?"‚úÖ ":"‚ùå ")+m;
      d.style.color=ok?"#bbf7d0":"#fecaca";
      d.style.margin="2px 0";
      logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
    }
    function escapeHTML(s){ return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function mdToHtml(md){
      // Tiny markdown to HTML (bold, italics, headers, bullets)
      let h = escapeHTML(md || "");
      h = h.replace(/^###### (.*)$/gm, "<h6>$1</h6>")
           .replace(/^##### (.*)$/gm, "<h5>$1</h5>")
           .replace(/^#### (.*)$/gm, "<h4>$1</h4>")
           .replace(/^### (.*)$/gm, "<h3>$1</h3>")
           .replace(/^## (.*)$/gm, "<h2>$1</h2>")
           .replace(/^# (.*)$/gm, "<h1>$1</h1>")
           .replace(/\*\*(.+?)\*\*/g, "<b>$1</b>")
           .replace(/\*(.+?)\*/g, "<i>$1</i>")
           .replace(/^- (.+)$/gm, "<li>$1</li>");
      h = h.replace(/(<li>[\s\S]*?<\/li>)/g, "<ul>$1</ul>");
      return h.replace(/\n{2,}/g,"<br/><br/>");
    }

    async function j(path, body){
      const url = api(path);
      const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body||{}) });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw data;
      return data;
    }

    // ------- UI helpers -------
    function clearOutputs(){
      slidesEl.textContent=""; flowEl.textContent=""; linksEl.innerHTML=""; pillsEl.innerHTML="";
      summaryEl.textContent="‚Äî"; blogEl.textContent="‚Äî";
      artStatus.style.display="none";
      logEl.innerHTML="";
    }

    function addPill(label, href){
      const pill=document.createElement("span"); pill.className="pill";
      const a=document.createElement("a"); a.textContent=label; a.href = href; a.target="_blank"; a.download="";
      pill.appendChild(a);
      const dl=document.createElement("small"); dl.textContent="‚≠≥";
      pill.appendChild(dl);
      pillsEl.appendChild(pill);
    }
    function linkIf(href, label){
      if (!href) return;
      const full = (backendBase()||"") + href;
      addPill(label, full);
      // Also show a compact link list under the diagram
      const a=document.createElement("a"); a.textContent=label; a.href=full; a.target="_blank"; a.download="";
      linksEl.appendChild(a);
    }

    async function showTextPreview(path, el){
      if (!path) return;
      try{
        const r = await fetch(api(path));
        const t = await r.text();
        el.innerHTML = "<pre>"+escapeHTML(t)+"</pre>";
      }catch{ el.textContent = "Could not load."; }
    }
    async function showMarkdownPreview(path, el){
      if (!path) return;
      try{
        const r = await fetch(api(path));
        const t = await r.text();
        el.innerHTML = mdToHtml(t);
      }catch{ el.textContent = "Could not load."; }
    }

    async function showArtifactsFromMap(a, topic){
      // a: { text, flowchart, outline_json, research_json, summary_md, blog_md, deck_pptx }
      linksEl.innerHTML = "";
      pillsEl.innerHTML = "";

      // pills + mini links
      linkIf(a.research_json, "research.json");
      linkIf(a.summary_md, "summary.md");
      linkIf(a.blog_md, "blog.md");
      linkIf(a.outline_json, "outline.json");
      linkIf(a.text, "slides.txt");
      linkIf(a.flowchart, "diagram.png");
      linkIf(a.deck_pptx, "deck.pptx");

      // previews
      await showTextPreview(a.text, slidesEl);
      await showMarkdownPreview(a.summary_md, summaryEl);
      await showMarkdownPreview(a.blog_md, blogEl);

      // flowchart preview
      if (a.flowchart){
        const img = document.createElement("img");
        img.src = api(a.flowchart) + "?t="+Date.now();
        img.style.maxWidth="100%";
        img.style.border="1px solid rgba(255,255,255,.1)";
        img.style.borderRadius="12px";
        flowEl.innerHTML=""; flowEl.appendChild(img);
      } else {
        flowEl.textContent = "No diagram yet.";
      }

      // status badge
      const done = Object.values(a||{}).filter(Boolean).length;
      artStatus.style.display="inline-flex";
      artStatus.textContent = done ? `Artifacts: ${done}` : "No artifacts";
    }

    function deriveDefaultPaths(topic){
      const tslug = topic.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
      const deck = `/out/${tslug.replace(/-/g,'_')}.pptx`;
      return {
        summary_md: `/out/summary_${tslug}.md`,
        blog_md: `/out/blog_${tslug}.md`,
        deck_pptx: deck
      };
    }

    // ------- Pipeline actions -------
    async function runAll(){
      const topic = topicEl.value.trim(), fast = fastEl.checked;
      clearOutputs(); setBusy(true); log("POST /v1/run_all ‚Ä¶");
      try{
        const out = await j("/v1/run_all",{topic, chart_slide_index:3, fast});
        const art = out.artifacts || {};
        const defaults = deriveDefaultPaths(topic);
        await showArtifactsFromMap({
          ...defaults, ...art
        }, topic);
        log("pipeline complete");
      }catch(e){ log(JSON.stringify(e), false); alert("Run failed (see Activity)."); }
      finally{ setBusy(false); }
    }

    async function runManual(){
      const topic = topicEl.value.trim(), fast = fastEl.checked;
      clearOutputs(); setBusy(true);
      try{
        const r = await j("/v1/research",{topic, fast}); log("research ok");

        // we know the path to research.json from server payload
        await j("/v1/synthesize",{topic, research_json:r.paths.research_json, fast}); log("synthesize ok");

        const o = await j("/v1/outline",{topic, research_json:r.paths.research_json, fast}); log("outline ok");

        const c = await j("/v1/content",{
          topic,
          outline_json:o.paths.outline_json,
          research_json:r.paths.research_json,
          chart_slide_index:3,
          fast
        }); log("content ok");

        const defaults = deriveDefaultPaths(topic);
        const artifacts = {
          text: c?.content_files?.text,
          flowchart: c?.content_files?.flowchart,
          outline_json: o?.paths?.outline_json,
          research_json: r?.paths?.research_json,
          ...defaults
        };

        await showArtifactsFromMap(artifacts, topic);
        log("pipeline complete");
      }catch(e){ log(JSON.stringify(e), false); alert("Run failed (see Activity)."); }
      finally{ setBusy(false); }
    }

    // ------- Wire up -------
    qs("#runAll").onclick = runAll;
    qs("#runManual").onclick = runManual;
    (async () => {
      try{
        const r = await fetch(api("/health"));
        const h = await r.json();
        qs("#health").textContent = JSON.stringify(h, null, 2);
      }catch{
        qs("#health").textContent = "Cannot reach backend at " + (backendBase() || "(proxy)");
      }
    })();
  </script>
</body>
</html>
