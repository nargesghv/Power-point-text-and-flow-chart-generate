##############################################
# Netlify config for GraphDeck frontend
##############################################

[build]
  # Folder that contains index.html
  publish = "src/graphdeck/web"
  # Static site — no build step
  command = ""

##############################################
# Caching
##############################################

# Always fetch a fresh index.html (avoid stale UI after deploys)
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma        = "no-cache"
    Expires       = "0"

# Allow other static files to be cached briefly
[[headers]]
  for = "/*"
  [headers.values]
    Cache-Control = "public, max-age=600"

##############################################
# Security headers (sane defaults for static UI)
##############################################
[[headers]]
  for = "/*"
  [headers.values]
    X-Content-Type-Options = "nosniff"
    X-Frame-Options        = "SAMEORIGIN"
    Referrer-Policy        = "no-referrer-when-downgrade"
    Permissions-Policy     = "geolocation=(), microphone=(), camera=()"

##############################################
# CORS (useful for downloading artifacts)
##############################################
[[headers]]
  for = "/out/*"
  [headers.values]
    Access-Control-Allow-Origin  = "*"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Access-Control-Allow-Headers = "*"
    Cache-Control = "no-store"

##############################################
# ---- PRODUCTION PROXY (Netlify CDN → HTTPS backend)
# Replace YOUR-BACKEND-DOMAIN with your real public backend.
# Note: Netlify prod cannot reach http://localhost.
##############################################

# API endpoints
[[redirects]]
  from = "/v1/*"
  to   = "https://YOUR-BACKEND-DOMAIN/v1/:splat"
  status = 200
  force  = true

# Generated artifacts (research.json, outline.json, summary.md, slides text, diagrams, pptx…)
[[redirects]]
  from = "/out/*"
  to   = "https://YOUR-BACKEND-DOMAIN/out/:splat"
  status = 200
  force  = true

# Health endpoint for the UI status panel
[[redirects]]
  from = "/health"
  to   = "https://YOUR-BACKEND-DOMAIN/health"
  status = 200
  force  = true


##############################################
# ---- LOCAL DEV PROXY (netlify dev)
# When you run:  netlify dev
# Netlify will proxy UI calls to your local backend at http://localhost:8003
# (These rules are only used by the Netlify CLI; safe to keep in the file.)
##############################################

[[redirects]]
  from = "/v1/*"
  to   = "http://localhost:8003/v1/:splat"
  status = 200
  force  = true
  conditions = { Environment = ["development"] }

[[redirects]]
  from = "/out/*"
  to   = "http://localhost:8003/out/:splat"
  status = 200
  force  = true
  conditions = { Environment = ["development"] }

[[redirects]]
  from = "/health"
  to   = "http://localhost:8003/health"
  status = 200
  force  = true
  conditions = { Environment = ["development"] }

##############################################
# (Optional) SPA fallback if you later add routing
##############################################
# [[redirects]]
#   from = "/*"
#   to   = "/index.html"
#   status = 200

