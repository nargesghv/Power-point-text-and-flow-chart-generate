##############################################
# Netlify config for GraphDeck frontend
##############################################

[build]
  # Folder that contains index.html
  publish = "src/graphdeck/web"
  # Static site — no build step
  command = ""

##############################################
# Caching
##############################################

# Always fetch a fresh index.html (avoid stale UI after deploys)
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma        = "no-cache"
    Expires       = "0"

# Allow other static files to be cached briefly
[[headers]]
  for = "/*"
  [headers.values]
    Cache-Control = "public, max-age=600"

##############################################
# Security headers (sane defaults for static UI)
##############################################
[[headers]]
  for = "/*"
  [headers.values]
    X-Content-Type-Options = "nosniff"
    X-Frame-Options        = "SAMEORIGIN"
    Referrer-Policy        = "no-referrer-when-downgrade"
    Permissions-Policy     = "geolocation=(), microphone=(), camera=()"

##############################################
# CORS for generated artifacts (/out/*)
##############################################
[[headers]]
  for = "/out/*"
  [headers.values]
    Access-Control-Allow-Origin  = "*"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Access-Control-Allow-Headers = "*"
    Cache-Control = "no-store"

##############################################
# -------- PRODUCTION (Netlify CDN → Public backend)
# Replace the domain below with your PUBLIC HTTPS backend.
# If your backend is only on localhost, use a tunnel (Cloudflare/Ngrok)
# and put that https URL here.
##############################################

# API
[[redirects]]
  from = "/v1/*"
  to   = "https://YOUR-PUBLIC-BACKEND/v1/:splat"
  status = 200
  force  = true

# Artifacts served by backend
[[redirects]]
  from = "/out/*"
  to   = "https://YOUR-PUBLIC-BACKEND/out/:splat"
  status = 200
  force  = true

# Health endpoint (UI status box)
[[redirects]]
  from = "/health"
  to   = "https://YOUR-PUBLIC-BACKEND/health"
  status = 200
  force  = true

##############################################
# -------- LOCAL DEV (netlify dev → localhost:8003)
# These rules are only used by the Netlify CLI in development.
##############################################

[[redirects]]
  from = "/v1/*"
  to   = "http://localhost:8003/v1/:splat"
  status = 200
  force  = true
  conditions = { Environment = ["development"] }

[[redirects]]
  from = "/out/*"
  to   = "http://localhost:8003/out/:splat"
  status = 200
  force  = true
  conditions = { Environment = ["development"] }

[[redirects]]
  from = "/health"
  to   = "http://localhost:8003/health"
  status = 200
  force  = true
  conditions = { Environment = ["development"] }

##############################################
# (Optional) SPA fallback if you add client routing later
##############################################
# [[redirects]]
#   from = "/*"
#   to   = "/index.html"
#   status = 200

